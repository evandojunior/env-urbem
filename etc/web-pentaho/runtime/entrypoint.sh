#!/bin/bash
set -e

ENVIRONMENT='DEV'
DB_PORT='5432'
DB_HOST_NAME=$(cat /etc/hosts | grep 'postgrehost' | awk '{print $1}' | uniq)
DB_DATABASE_NAME='etl'
DB_USER='docker'
DB_PASSWORD='docker'

IP=$(awk 'END{print $1}' /etc/hosts)
CONFIGURATION_FILE="/opt/pentaho/configuration-server.xml"

export KETTLE_HOME=/opt/pentaho/pdi

# Copia os arquivos de configurações
cat <<< "<slave_config>
  <slaveserver>
    <name>Slave01</name>
    <hostname>${IP}</hostname>
    <port>8081</port>
  </slaveserver>

  <!--<masters>
    <slaveserver>
      <name>master1</name>
      <hostname>${IP}</hostname>
      <port>8082</port>
      <webAppName>pentaho-di</webAppName>
      <username>admin</username>
      <password>password</password>
      <master>Y</master>
    </slaveserver>
  </masters>-->

  <report_to_masters>Y</report_to_masters>

  <max_log_lines>10000</max_log_lines>
  <max_log_timeout_minutes>1440</max_log_timeout_minutes>
  <object_timeout_minutes>1440</object_timeout_minutes>
</slave_config>" > ${CONFIGURATION_FILE}

# Repositorio
cat <<< "<?xml version='1.0' encoding='UTF-8'?>
<repositories>
  <repository>
    <id>KettleFileRepository</id>
    <name>${ENVIRONMENT}</name>
    <description>${ENVIRONMENT}</description>
    <is_default>true</is_default>
    <base_directory>/var/www/pentaho/pdi</base_directory>
    <read_only>N</read_only>
    <hides_hidden_files>N</hides_hidden_files>
  </repository>
</repositories>" > ${KETTLE_HOME}/.kettle/repositories.xml

# Config kettle
cat <<< "## This file was generated by Pentaho Data Integration version 7.0.0.0-25.
#
# Here are a few examples of variables to set:
#
# PRODUCTION_SERVER = hercules
# TEST_SERVER = zeus
# DEVELOPMENT_SERVER = thor
#
# Note: lines like these with a # in front of it are comments
#
#
#Wed Aug 09 15:37:22 BRT 2017
KETTLE_CORE_JOBENTRIES_FILE=
KETTLE_LAZY_REPOSITORY=true
KETTLE_DEFAULT_DATE_FORMAT=
KETTLE_JOB_LOG_SCHEMA=etl
KETTLE_CHANNEL_LOG_TABLE=channel
KETTLE_TRANS_PAN_JVM_EXIT_CODE=
KETTLE_SPLIT_FIELDS_REMOVE_ENCLOSURE=false
DB_PORT=${DB_PORT}
vfs.sftp.userDirIsRoot=false
KETTLE_COMPATIBILITY_PUR_OLD_NAMING_MODE=N
KETTLE_CARTE_JETTY_ACCEPT_QUEUE_SIZE=
KETTLE_MAX_LOGGING_REGISTRY_SIZE=10000
KETTLE_JNDI_ROOT=
KETTLE_DEFAULT_TIMESTAMP_FORMAT=
KETTLE_MAX_LOG_TIMEOUT_IN_MINUTES=1440
KETTLE_SHARED_OBJECTS=
KETTLE_METRICS_LOG_TABLE=transformation_metric
KETTLE_BATCHING_ROWSET=N
KETTLE_TRANS_LOG_TABLE=transformation
KETTLE_JOBENTRY_LOG_SCHEMA=${DB_DATABASE_NAME}
KETTLE_METRICS_LOG_DB=${DB_DATABASE_NAME}
KETTLE_DEFAULT_INTEGER_FORMAT=
KETTLE_CARTE_JETTY_RES_MAX_IDLE_TIME=
KETTLE_PLUGIN_CLASSES=
KETTLE_DEFAULT_BIGNUMBER_FORMAT=
DB_NAME=${DB_DATABASE_NAME}
DB_ETL_PORT=${DB_PORT}
KETTLE_REDIRECT_STDERR=N
KETTLE_FAIL_ON_LOGGING_ERROR=N
KETTLE_ROWSET_GET_TIMEOUT=50
KETTLE_CHANNEL_LOG_DB=${DB_DATABASE_NAME}
KETTLE_METRICS_LOG_SCHEMA=${DB_DATABASE_NAME}
KETTLE_EMPTY_STRING_DIFFERS_FROM_NULL=N
DB_PASSWORD=${DB_PASSWORD}
KETTLE_ROWSET_PUT_TIMEOUT=50
KETTLE_AGGREGATION_MIN_NULL_IS_VALUED=N
KETTLE_JOB_LOG_TABLE=job
KETTLE_DEFAULT_NUMBER_FORMAT=
KETTLE_DEFAULT_SERVLET_ENCODING=
KETTLE_REDIRECT_STDOUT=N
DB_ETL_HOST_NAME=${DB_HOST_NAME}
KETTLE_TRANS_LOG_DB=${DB_DATABASE_NAME}
KETTLE_TRANS_PERFORMANCE_LOG_SCHEMA=${DB_DATABASE_NAME}
KETTLE_MAX_LOG_SIZE_IN_LINES=5000
KETTLE_JOBENTRY_LOG_TABLE=job_entry
KETTLE_PLUGIN_PACKAGES=
KETTLE_COMPATIBILITY_TEXT_FILE_OUTPUT_APPEND_NO_HEADER=N
DB_ETL_NAME=${DB_DATABASE_NAME}
KETTLE_DISABLE_CONSOLE_LOGGING=N
DB_HOST_NAME=${DB_HOST_NAME}
KETTLE_TRANS_PERFORMANCE_LOG_DB=${DB_DATABASE_NAME}
KETTLE_MAX_JOB_TRACKER_SIZE=5000
PENTAHO_METASTORE_FOLDER=
KETTLE_STEP_LOG_TABLE=transformation_step
KETTLE_STEP_PERFORMANCE_SNAPSHOT_LIMIT=0
KETTLE_CORE_STEPS_FILE=
KETTLE_STEP_LOG_DB=${DB_DATABASE_NAME}
DB_ETL_USER_NAME=${DB_USER}
KETTLE_AGGREGATION_ALL_NULLS_ARE_ZERO=N
KETTLE_LENIENT_STRING_TO_NUMBER_CONVERSION=N
KETTLE_LOG_SIZE_LIMIT=0
KETTLE_PASSWORD_ENCODER_PLUGIN=Kettle
KETTLE_JOB_LOG_DB=${DB_DATABASE_NAME}
KETTLE_TRANS_PERFORMANCE_LOG_TABLE=transformation_performance
KETTLE_CHANNEL_LOG_SCHEMA=${DB_DATABASE_NAME}
KETTLE_STEP_LOG_SCHEMA=${DB_DATABASE_NAME}
KETTLE_JOBENTRY_LOG_DB=${DB_DATABASE_NAME}
KETTLE_CARTE_JETTY_ACCEPTORS=
DB_ETL_PASSWORD=${DB_PASSWORD}
KETTLE_COMPATIBILITY_MERGE_ROWS_USE_REFERENCE_STREAM_WHEN_IDENTICAL=N
DB_USER_NAME=${DB_USER}
KETTLE_HIDE_DEVELOPMENT_VERSION_WARNING=N
KETTLE_SYSTEM_HOSTNAME=
KETTLE_CARTE_OBJECT_TIMEOUT_MINUTES=1440
KETTLE_LOG_MARK_MAPPINGS=N
KETTLE_MAX_JOB_ENTRIES_LOGGED=5000
KETTLE_COMPATIBILITY_IMPORT_PATH_ADDITION_ON_VARIABLES=N
KETTLE_COMPATIBILITY_DB_IGNORE_TIMEZONE=N
KETTLE_TRANS_LOG_SCHEMA=${DB_DATABASE_NAME}" > ${KETTLE_HOME}/.kettle/kettle.properties

# Up Carte
#cat ${CONFIGURATION_FILE}
#ls -lah /opt/pentaho/pdi/data-integration/carte.sh

#/usr/bin/bash /opt/pentaho/pdi/data-integration/carte.sh ${CONFIGURATION_FILE}
./opt/pentaho/pdi/data-integration/carte.sh ${CONFIGURATION_FILE}